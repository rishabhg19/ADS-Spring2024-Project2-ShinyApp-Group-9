---
title: "APD Project 2"
output: html_document
date: "2024-02-17"
---

```{r setup}
library(httr)
library(jsonlite)
library(dplyr)
url <- GET("https://www.fema.gov/api/open/v2/FimaNfipClaims")
my_content <- content(url, as = 'text')
json_content <- fromJSON(my_content)
data <- fromJSON(rawToChar(url$content))
claims <- data$FimaNfipClaims
```


```{r annual}
library(lubridate)
library(ggplot2)
library(plotly)

#get annual frequency of claims
claims$dateOfLoss <- as.Date((claims$dateOfLoss), format = "%Y-%m-%d")
claims$year <- format(claims$dateOfLoss, "%Y")

# Plot bar chart with annual frequency
ggplot(claims, aes(x = year)) +
  geom_bar(fill = "blue", color = "white", alpha = 0.7) + 
  labs(title = "Bar Chart of Dates from Claims Data (Annually)",
       x = "Month",
       y = "Frequency") + theme(axis.text.x = element_text(angle=90, vjust=.5, hjust=1))

```
Plotted annual data to see if there was a trend in the number of FEMA claims over time. According to the chart, there seems to be no visible trend. There were peaks in NFIP claims around 2004-2005 and 2020.

According to E&E News https://www.eenews.net/articles/analysis-8-counties-got-half-of-2020-flood-claims/,

"Eight counties — in Alabama, Florida and Louisiana — accounted for half of the claims payments, which arose from a series of storms that caused major but not catastrophic damage during last year’s record-breaking Atlantic hurricane season. There were a record 30 named storms from June to December including 13 hurricanes and six major hurricanes reaching Category 3 or higher.

Hurricane Sally, a Category 2 storm in September that hit the Gulf Coast in Alabama and Florida, accounted for roughly one-third of the claims paid by the National Flood Insurance Program in 2020."


```{r buildings}
library(lubridate)
library(ggplot2)
library(plotly)

# Plot bar chart of types of buildings affected
ggplot(claims, aes(x = buildingDescriptionCode)) +
  geom_bar(fill = "blue", color = "white", alpha = 0.7) + 
  labs(title = "Types of Buildings assoicated with NFIP claims ",
       x = "Building Description Code",
       y = "Frequency") + scale_x_continuous(breaks = scales::pretty_breaks(n = 20)) + scale_y_continuous(limits = c(0,900)) + geom_text(aes(label = ..count..), stat = "count", vjust = -0.5, colour = "black")
```
Then I wanted to observe the types of buildings that are most impacted as reported by the number of claims:

1) Main buidling
2) Detached guest house
3) Detached garage
5) Warehouse
6) Pool House, Clubhouse, Recreation Building
8) Other
10) Apartment building

```{r city_state}

library(lubridate)
library(ggplot2)
library(plotly)

#plot bar chart of states with FEMA claims
ggplot(claims, aes(x = state)) +
  geom_bar(fill = "blue", color = "white", alpha = 0.7) + 
  labs(title = "States with Most Frequent NFIP Claims",
       x = "State", y = "Frequency") + theme(axis.text.x = element_text(angle=90, vjust=.5, hjust=1)) + scale_y_continuous(limits = c(0,1020)) + geom_text(aes(label = ..count..), stat = "count", vjust = -0.5, colour = "black")

#pie chart of Alabama zipcodes with most frequent NFIP claims
AL_zipcodes = table(subset(claims, state == 'AL', select = reportedZipCode))
lbls <- as.numeric(AL_zipcodes)
labels_with_freq <- ifelse(lbls > 10, paste(names(AL_zipcodes), " (", lbls, ")", sep = ""), "")
pie(AL_zipcodes, labels = labels_with_freq, main="Pie Chart of AL Zip Codes")
```
Then I wanted to observe the states that hahd the most NFIP claims which was Alabama by a land slide. This is consistent with the news article shown prior as well. 

The pie chart delved deeper into the state of Alabama by looking at the zip codes that had the most claims tied to it. 

36542- Baldwin County
36561- Baldwin County
36528- Dauphin Island
36532- Baldwin County
36535- Baldwin County

Baldwin County is on the Gulf Coast and borders the Gulf of Mexico. This explains the number of claims espeically in 2020 when Hurrican Sally hit the Gulf Coast.

```{r floodzone}

# Plot bar chart of floodzone frequencies
ggplot(claims, aes(x = floodZoneCurrent)) +
  geom_bar(fill = "blue", color = "white", alpha = 0.7) + 
  labs(title = "Types of Flood Zones assoicated with NFIP claims ",
       x = "Flood Zone",
       y = "Frequency") + scale_y_continuous(limits = c(0,610)) + geom_text(aes(label = ..count..), stat = "count", vjust = -0.5, colour = "black")
```
Zone A, Zones A1-A30, Zone AE, Zone AO, Zone V, Zone VE, and Zones V1-V30 are Special Flood Hazard Areas (SFHAs). These are defined as areas that will likely be inundated by the flood event having a 1-percent chance of being equaled or exceeded in any given year.

Zone X is a moderate flood hazard area which is between the limits of the base flood and the 0.2-percent-annual-chance flood.

```{r states_floodzone}

#States with SFHA

#index by zones that are SFHA
states_SFHA = table(subset(claims, floodZoneCurrent == 'A' | floodZoneCurrent == 'A06' | floodZoneCurrent == 'A08' | floodZoneCurrent == 'A09' | floodZoneCurrent == 'A11' | floodZoneCurrent == 'AE' | floodZoneCurrent == 'AOB' | floodZoneCurrent == 'V09' | floodZoneCurrent == 'V10' | floodZoneCurrent == 'V12' | floodZoneCurrent == 'V15' | floodZoneCurrent == 'VE', select = state))
lbls <- as.numeric(states_SFHA)
print(states_SFHA)
labels_with_freq <- paste(names(states_SFHA), " (", lbls, ")", sep = "")
pie(states_SFHA, labels = labels_with_freq, main="Pie Chart of States with SFHA")

#moderate flood hazard area

#index by zones that are MFHA
states_MFHA = table(subset(claims, floodZoneCurrent == 'X', select = state))
lbls <- as.numeric(states_MFHA)
print(states_MFHA)
labels_with_freq <- paste(names(states_MFHA), " (", lbls, ")", sep = "")
pie(states_MFHA, labels = labels_with_freq, main="Pie Chart of States with MFHA")
```

```{r cause_of_damage}

# Plot bar chart with frequency of cause of damage
ggplot(claims, aes(x = causeOfDamage)) +
  geom_bar(fill = "blue", color = "white", alpha = 0.7) + 
  labs(title = "What Caused Flood Damage ",
       x = "Cause of Flood Damage",
       y = "Frequency") + scale_y_continuous(limits = c(0,400)) + geom_text(aes(label = ..count..), stat = "count", vjust = -0.5, color = "black")

#what's causing flood damage in Alabama
AL_damage = subset(claims, state == 'AL')
ggplot(AL_damage, aes(x = causeOfDamage)) +
  geom_bar(fill = "blue", color = "white", alpha = 0.7) + 
  labs(title = "What Caused Flood Damage in Alabama",
       x = "Cause of Flood Damage",
       y = "Frequency") + scale_y_continuous(limits = c(0,400)) + geom_text(aes(label = ..count..), stat = "count", vjust = -0.5, color = "black")
```

Based on the data, the following are causing the most flood damage:

0) Other causes
1) Tidal water overflow
2) Stream, river, or lake overflow
3) Alluvial fan overflow
4) Accumulation of rainfall or snowmelt
B) Expedited claim handling process without site inspection

```{r floodproof}

#are structures in Alabama flood proofed?
ggplot(AL_damage, aes(x = floodproofedIndicator)) +
  geom_bar(fill = "blue", color = "white", alpha = 0.7) + 
  labs(title = "Are buildings in Alabama floodproofed?",
       x = "Floodproof Indicator",
       y = "Frequency") + scale_y_continuous(limits = c(0,1100)) + geom_text(aes(label = ..count..), stat = "count", vjust = -0.5, color = "black")
```
The most interesting metric in my opinion as this likely explain why so many claims were filed from Alabama. If other regions are better equipped,for floods then they wouldn't have to file as many claims. 
